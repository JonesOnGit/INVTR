<!-- <h1>Show Invite</h1> -->

<div class="margin-top row">
  <div class="medium-12 columns invite_details">
    <%= render 'details', invite: @invite %>

    <% if @invite.owner == @email %>
      <a class="button" onclick="loadContacts();" data-reveal-id="myModal2">See Stats</a>
    <% else %>
      <% if @invite.oauth_provider == "none" %>
        <a href="#" data-reveal-id="myModal">Click to enter Invite password</a>

        <div id="myModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
          <h2 id="modalTitle">Log into <%= @invite.name %></h2>
           <form action="/authorize_noauth" method="post">
            password:<br>
            <input type="text" name="password"><br>
            <input type="hidden" name="invite_id" value="<%= @invite.id %>">
            <input type="submit" value="Submit">
          </form> 
          <a class="close-reveal-modal" aria-label="Close">&#215;</a>
        </div>
      <% end %>
      <% if @invite.oauth_provider == "google" %>
        <button onclick="auth();">Login With Gmail Account</button>
      <% end %>
      <% if @invite.oauth_provider == "hotmail" %>
       <a href="<%= @session_url %>" id="hotmailLogin">Sign in to outlook</a>

      <% end %>
    <% end %>

    <% if current_user %>
      <p>Total reports: <%= @invite.report_count %></p>
      <% if @invite.reports %>
        <table>
          <thead>
            <tr>
              <th>Reports</th>
            </tr>
          </thead>
          <tbody>
            <% @invite.reports.each do |report| %>
            <tr>
              <td><%= report %></td>
            </tr>
          <% end %>
          </tbody>
        </table>
      <% end %>

      <%= simple_form_for @invite, url: "/invites/#{@invite.id}/deactivate" do |f| %>
       <div class="margin-top row">
         <div class="medium-12 columns">
           <%= f.input :deactivation_reason %>
         </div>
       </div>
       <div class="row">
         <div class="large-12 columns">
           <%= f.button :submit %>
         </div>
       </div>
      <% end %>
    <% end %>
  </div>
</div>

<div class="row">
    <div id="myModal2" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">

    <div id="no-overflow">
         <div class="large-3 columns">
           Gmail <%= image_tag("gmail", size: "60x60") %>
         </div>

         <div class="large-9 columns">
           <input type="text" name="autocorrect" id="autocorrect" placeholder="Search"><br>
         </div>

         <div class="large-12 columns" id="contacts-table">
          <table id="myModal2-table">
            <tbody id="myModal2-table-body">
            </tbody>
          </table>
         </div>
     </div>

       <div class="large-9 columns">
         <p>We believe in privacy. We won't spam your contacts.</p>
       </div>

       <div class="large-3 columns">
         <a class='button' id='continue-button'>Done</a>
       </div>
   </div>
</div>

<script src="https://apis.google.com/js/client.js"></script>

<script>
function auth() {
  var config = {
    'client_id': '832245431959-4qt4jj9euf22pd3d6tdsqknrdd32nuem.apps.googleusercontent.com',
    'scope': 'https://www.google.com/m8/feeds'
  };
  gapi.auth.authorize(config, function() {
    var token = gapi.auth.getToken();
    // console.log(token)
    token['g-oauth-window'] = null;
    fetchGoogleContacts(token);
  });
}

function fetchGoogleContacts(token) {
  $.ajax({
    url: 'https://www.google.com/m8/feeds/contacts/default/full?alt=json&max-results=1000',
    dataType: 'jsonp',
    data: token
  }).done(function(data) {
    
    console.log("here");
    data["feed"]["id"]["$t"];
    // run a post call here
    $.post("/authorize_google",
        {
            email: data["feed"]["id"]["$t"],
            invite_id: "<%= @invite.id %>"
        }
        ,
        function(data, status){
            console.log(status);
            if (status == "success") {
              location.reload();
            } else {

            }
        })
  });
}
</script>

<script>
function loadContacts() {
  console.log('<%= @invite.invited %>'); 
  var invited = JSON.parse('<%= @invite.invited.to_json %>'.replace(/&quot;/g,'"'));
  var accepted = JSON.parse('<%= @invite.accepted.to_json %>'.replace(/&quot;/g,'"'));
  for (var i = 0; i < invited.length; i++) {
    console.log(invited[i]);
    $("#myModal2-table-body").append("<tr>");

    $("#myModal2-table-body").append("<td>");

    if ($.inArray(invited[i], accepted)) {
      $("#myModal2-table-body").append("<input class='emailCheckbox' type=checkbox name='" + invited[i] + "'' id='" + invited[i] + "' disabled /><label for='" + invited[i] + "'></label>");
    } else {
      $("#myModal2-table-body").append("<input class='emailCheckbox' type=checkbox name='" + invited[i] + "'' id='" + invited[i] + "' disabled checked/><label for='" + invited[i] + "'></label>");
    }
    
    $("#myModal2-table-body").append("</td>");
    $("#myModal2-table-body").append("<td>");

    $("#myModal2-table-body").append("  <b>" + invited[i] + "<b>  ");
    $("#myModal2-table-body").append("<br/>");

    $("#myModal2-table-body").append(invited[i]);
    
    $("#myModal2-table-body").append("</td>");
    $("#myModal2-table-body").append("<tr>");
  }
}
</script>
